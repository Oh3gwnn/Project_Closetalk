<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JOIN</title>
</head>
<body>
<header th:insert="~{header :: header}"></header>

<main class="main-content">
    <div class="title">
        <h1>JOIN</h1>
    </div>
    <form th:action="@{/users/register}" method="post" enctype="multipart/form-data">
        <div class="div-input">
            <table>
                <thead></thead>
                <tbody>
                    <tr><td><label>아이디</label></td>
                        <td><input name="loginId" placeholder="ID"></td></tr>
                    <tr><td><label>비밀번호</label></td>
                        <td><input name="password" type="password" placeholder="PASSWORD"></td></tr>
                    <tr><td><label>비밀번호 확인</label></td>
                        <td><input name="password-check" type="password" placeholder="PASSWORD"></td></tr>
                    <tr><td><label>이메일</label></td>
                        <td>
                            <input name="show-email" placeholder="email" id="input-email">
                            <input name="email" type="hidden" placeholder="email" id="input-real-email">
                            <button type="button" id="btn-mail-send">인증번호 받기</button>
                        </td>
                    </tr>
                    <tr><td><label>이메일 인증</label></td>
                        <td>
                            <input name="email-auth-code" placeholder="인증번호" disabled="true" id="input-auth-code">
                            <button type="button" id="btn-code-check">인증</button>
                        </td>
                    </tr>
                    <input name="social" type="hidden">
                    <tr><td><label>닉네임</label></td>
                        <td><input name="nickname"></td></tr>
                    <tr><td><label>프로필 이미지</label></td>
                        <td><input name="profile-image" type="file"></td></tr>
                </tbody>
            </table>
        </div>
        <div>
            <button type="submit">가입</button>
        </div>
    </form>
</main>

<footer th:insert="footer"></footer>


<!--<script type="text/javascript" th:src="@{../js/join-form.js}" ></script>-->
<script type="text/javascript">
    /*

할일 1. 이메일 발송 처리
할일 2. 이메일 인증코드 확인
할일 3. 가입 처리 시 성공 응답 확인 후 로그인 페이지 요청하기

 */
    let authCode;

    const btnMailSend = document.querySelector('#btn-mail-send')


    btnMailSend.addEventListener("click", () => {
        console.log("이메일 전송 버튼 클릭")
        const emailDto = document.querySelector('#input-email').value
        const url = "users/sendEmail"
        fetch(url, {
            method: "POST",
            body: JSON.stringify(emailDto),
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then((response) =>
                response.json()

            .then((json) => {
                console.log(json)
                if (json !== null) {
                    alert("인증메일이 전송 되었습니다.")
                    authCode = json.authCode
                    document.querySelector('#input-auth-code').disabled = false
                    btnMailSend.disabled = true
                } else {
                    alert("인증메일 전송에 실패 하였습니다.")
                }
            }));
    });

    const btnCodeCheck = document.querySelector('#btn-code-check')
    btnCodeCheck.addEventListener("click", () => {
        console.log("인증 버튼 클릭")
        const inputAuthCode = document.querySelector('#input-auth-code')

        let message;
        if(authCode !== inputAuthCode.value){
            //alert
            message = '인증코드가 일치하지 않습니다'
        } else {
            //alert
            inputAuthCode.setAttribute('disabled', 'true')
            message = '인증되었습니다.'

            document.querySelector('#input-auth-code').disabled = true;
            btnCodeCheck.disabled = true;
            document.querySelector('#input-email').disabled = true;
            document.querySelector("#input-real-email").value = document.querySelector('#input-email').value

        }
        alert(message)
    })

</script>
</body>
</html>